document.documentElement.setAttribute("data-theme","dracula");const wsStatus=document.getElementById("wsStatus");const pinGrid=document.getElementById("pinGrid");const pinFilter=document.getElementById("pinFilter");const pinSearch=document.getElementById("pinSearch");const boardLabel=document.getElementById("boardLabel");let socket=null;let pins=[];const pinRuntime=new Map();const pendingModes=new Map();const MODE_PENDING_TTL_MS=2000;function getEffectiveMode(gpio,runtime){if(!runtime || gpio===undefined){return runtime?.mode ?? "input";}const pending=pendingModes.get(gpio);if(!pending){return runtime.mode;}if(Date.now()> pending.expiresAt){pendingModes.delete(gpio);return runtime.mode;}if(runtime.mode===pending.mode){pendingModes.delete(gpio);return runtime.mode;}return pending.mode;}function isModePending(gpio,runtime){if(gpio===undefined || !runtime){return false;}const pending=pendingModes.get(gpio);if(!pending){return false;}if(Date.now()> pending.expiresAt || runtime.mode===pending.mode){pendingModes.delete(gpio);return false;}return true;}function isConnected(){return socket && socket.readyState===WebSocket.OPEN;}function sendWs(payload){if(!isConnected()){return;}socket.send(JSON.stringify(payload));}function getLiveBadge(gpio){if(gpio===undefined){return '<span class="badge badge-outline">N/A</span>';}const runtime=pinRuntime.get(gpio);if(!runtime){return '<span class="badge badge-warning">Unknown</span>';}if(runtime.value){return '<span class="badge badge-success">High</span>';}return '<span class="badge badge-error">Low</span>';}function getCategoryBadge(category){if(category==="reserved")return '<span class="badge badge-secondary">Reserved</span>';return '<span class="badge badge-primary">Digital I/O</span>';}function modeLabel(mode){if(mode==="output")return "Output";if(mode==="input_pullup")return "Input Pullup";return "Input";}function getActionButton(pin,runtime){if(pin.gpio===undefined){return '<button class="btn btn-sm btn-outline" disabled>N/A</button>';}if(!isConnected()){return `<button class="btn btn-sm btn-outline" disabled data-gpio="${pin.gpio}">Offline</button>`;}if(!runtime){return `<button class="btn btn-sm btn-outline" disabled data-gpio="${pin.gpio}">Wait</button>`;}if(!runtime.canControl){return `<button class="btn btn-sm btn-outline" disabled data-gpio="${pin.gpio}">Reserved</button>`;}if(runtime.mode !=="output"){return `<button class="btn btn-sm btn-outline" disabled data-gpio="${pin.gpio}">Set Output</button>`;}const nextValue=runtime.value ? "0":"1";const buttonText=runtime.value ? "Set Low":"Set High";return `<button class="btn btn-sm btn-outline" data-action="toggle" data-gpio="${pin.gpio}" data-next="${nextValue}">${buttonText}</button>`;}function renderPins(){if(!pinGrid)return;const filterValue=pinFilter?.value ?? "all";const query=(pinSearch?.value ?? "").trim().toLowerCase();const filteredPins=pins.filter((pin)=>{const availabilityMatch=filterValue==="all" ||(filterValue==="available" && pin.canControl)||(filterValue==="reserved" && !pin.canControl);const searchMatch=query.length===0 || pin.label.toLowerCase().includes(query)|| String(pin.number).includes(query);return availabilityMatch && searchMatch;});if(filteredPins.length===0){pinGrid.innerHTML='<div class="alert">No pins match this filter.</div>';return;}pinGrid.innerHTML=filteredPins .map((pin)=>{const runtime=pin.gpio !==undefined ? pinRuntime.get(pin.gpio):null;const gpioText=pin.label.startsWith("IO")? `GPIO ${pin.label.slice(2)}`:pin.label;const selectedMode=getEffectiveMode(pin.gpio,runtime);const pendingMode=isModePending(pin.gpio,runtime);const modeDisabled=pin.gpio===undefined || !isConnected()|| !runtime?.canControl;return ` <div class="pin-card"> <div class="pin-card-head"> <div class="font-semibold">${pin.number}:${pin.label}</div> ${getLiveBadge(pin.gpio)}</div> <div class="pin-card-meta"> ${getCategoryBadge(pin.category)}<span class="badge badge-outline">${gpioText}</span> <span class="badge badge-ghost">Mode:${modeLabel(selectedMode)}</span> ${pendingMode ? '<span class="badge badge-info">Updating…</span>':""}</div> <div class="pin-card-controls"> <select class="select select-bordered select-sm" data-action="mode" data-gpio="${pin.gpio ?? ""}" aria-label="Mode for ${pin.label}" ${modeDisabled ? "disabled":""}> <option value="input" ${selectedMode==="input" ? "selected":""}>Input</option> <option value="input_pullup" ${selectedMode==="input_pullup" ? "selected":""}>Input Pullup</option> <option value="output" ${selectedMode==="output" ? "selected":""}>Output</option> </select> ${getActionButton(pin,runtime)}</div> </div>`;}).join("");}function setWsState(state){if(!wsStatus)return;if(state==="connected"){wsStatus.textContent="Connected";wsStatus.className="badge badge-success";return;}if(state==="disconnected"){wsStatus.textContent="Disconnected";wsStatus.className="badge badge-error";return;}wsStatus.textContent="Connecting…";wsStatus.className="badge badge-warning";}function connectWebSocket(){setWsState("connecting");const protocol=window.location.protocol==="https:" ? "wss":"ws";socket=new WebSocket(`${protocol}://${window.location.host}/ws`);const connectTimeout=window.setTimeout(()=>{if(socket.readyState===WebSocket.CONNECTING){setWsState("disconnected");socket.close();}},3000);socket.addEventListener("open",()=>{window.clearTimeout(connectTimeout);setWsState("connected");sendWs({type:"snapshot"});renderPins();});socket.addEventListener("message",(event)=>{try{const data=JSON.parse(event.data);let shouldRender=false;if(data.type==="snapshot" && Array.isArray(data.pins)){if(typeof data.target==="string" && boardLabel){boardLabel.textContent=data.target;}const nextPins=data.pins .filter((item)=> typeof item.gpio==="number").map((item)=>({number:item.gpio,label:`IO${item.gpio}`,category:item.canControl===false ? "reserved":"digital",canControl:item.canControl !==false,gpio:item.gpio,})).sort((a,b)=> a.gpio - b.gpio);if(nextPins.length !==pins.length){pins=nextPins;shouldRender=true;}else{for(let i=0;i < nextPins.length;i++){if(nextPins[i].gpio !==pins[i].gpio || nextPins[i].canControl !==pins[i].canControl){pins=nextPins;shouldRender=true;break;}}}for(const item of data.pins){if(typeof item.gpio !=="number")continue;const oldRuntime=pinRuntime.get(item.gpio);const nextRuntime={mode:typeof item.mode==="string" ? item.mode:"input",value:Boolean(item.value),canControl:item.canControl !==false,};if(!oldRuntime || oldRuntime.mode !==nextRuntime.mode || oldRuntime.value !==nextRuntime.value || oldRuntime.canControl !==nextRuntime.canControl){shouldRender=true;}pinRuntime.set(item.gpio,{mode:nextRuntime.mode,value:nextRuntime.value,canControl:nextRuntime.canControl,});}}if(shouldRender){renderPins();}}catch{setWsState("disconnected");}});socket.addEventListener("close",()=>{window.clearTimeout(connectTimeout);setWsState("disconnected");renderPins();window.setTimeout(connectWebSocket,1000);});socket.addEventListener("error",()=>{window.clearTimeout(connectTimeout);setWsState("disconnected");socket.close();});}pinGrid?.addEventListener("change",(event)=>{const target=event.target;if(!(target instanceof HTMLSelectElement)){return;}if(target.dataset.action !=="mode"){return;}const gpio=Number(target.dataset.gpio);if(!Number.isInteger(gpio)){return;}pendingModes.set(gpio,{mode:target.value,expiresAt:Date.now()+ MODE_PENDING_TTL_MS,});window.setTimeout(()=>{const pending=pendingModes.get(gpio);if(pending && Date.now()> pending.expiresAt){pendingModes.delete(gpio);renderPins();}},MODE_PENDING_TTL_MS + 50);const runtime=pinRuntime.get(gpio);if(runtime){runtime.mode=target.value;pinRuntime.set(gpio,runtime);}renderPins();sendWs({type:"set",gpio,mode:target.value});});pinGrid?.addEventListener("click",(event)=>{const target=event.target;if(!(target instanceof HTMLButtonElement)){return;}if(target.dataset.action !=="toggle"){return;}const gpio=Number(target.dataset.gpio);const next=target.dataset.next==="1";if(!Number.isInteger(gpio)){return;}sendWs({type:"write",gpio,value:next});});pinFilter?.addEventListener("change",renderPins);pinSearch?.addEventListener("input",renderPins);renderPins();connectWebSocket();